<div class="lists-container">
  <!-- Header -->
  <div class="header">
    <h1>Reservations List</h1>
    <button class="refresh-btn" (click)="loadReservations()" [disabled]="loading">
      <i class="fa fa-refresh"></i>
      {{ loading ? 'Loading...' : 'Refresh' }}
    </button>
  </div>

  <!-- Search Bar -->
  <div class="search-container">
          <div class="search-box">
        <input 
          type="text" 
          placeholder="Search reservations..." 
          [(ngModel)]="searchTerm" 
          (input)="onSearchTermChange()"
          (keyup)="onSearchTermChange()"
          (blur)="onSearchTermChange()"
          autocomplete="off"
          spellcheck="false">
        <button 
          *ngIf="searchTerm.trim()" 
          (click)="clearSearch()" 
          class="clear-search"
          type="button">
          âœ•
        </button>
      </div>
  </div>

  <!-- Search Results Info -->
  <div *ngIf="searchTerm.trim()" class="searched-name">
    Searched: {{ searchTerm }}
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="error">
    <i class="fa fa-exclamation-triangle"></i>
    {{ error }}
    <button (click)="error = ''" class="close-error">
      <i class="fa fa-times"></i>
    </button>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading reservations...</p>
  </div>

  <!-- Reservations Table -->
  <div class="table-container" *ngIf="!loading">
    <table class="reservations-table">
      <thead>
        <tr>
          <th>Guest Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Room Type</th>
          <th>Check In</th>
          <th>Check Out</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let reservation of filteredReservations" class="reservation-row">
          <td>{{ getGuestName(reservation) }}</td>
          <td>{{ reservation.guest_email }}</td>
          <td>{{ reservation.guest_phone }}</td>
          <td>{{ reservation.roomType }}</td>
          <td>{{ formatDate(reservation.checkIn) }}</td>
          <td>{{ formatDate(reservation.checkOut) }}</td>
          <td class="actions">
            <button class="btn-extend" (click)="openExtendModal(reservation)">
              <i class="fa fa-calendar-plus"></i>
              Extend
            </button>
            <button class="btn-checkout" (click)="openCheckoutModal(reservation)">
              <i class="fa fa-sign-out-alt"></i>
              Check Out
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredReservations.length === 0 && !loading">
      <i class="fa fa-bed"></i>
      <h3 *ngIf="searchTerm.trim()">No Search Results</h3>
      <h3 *ngIf="!searchTerm.trim()">No Active Reservations</h3>
      <p *ngIf="searchTerm.trim()">No reservations found matching "{{ searchTerm }}"</p>
      <p *ngIf="!searchTerm.trim()">There are currently no active reservations to display.</p>
      <p *ngIf="searchTerm.trim()" class="search-tips">Try searching by guest name, email, phone, or room type</p>
    </div>
  </div>

  <!-- Extend Stay Modal -->
  <div class="modal-overlay" *ngIf="showExtendModal" (click)="cancelExtend()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Extend Stay</h2>
        <button class="close-btn" (click)="cancelExtend()">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="guest-info">
          <p><strong>Guest:</strong> {{ selectedReservation ? getGuestName(selectedReservation) : '' }}</p>
          <p><strong>Room Type:</strong> {{ selectedReservation?.roomType }}</p>
          <p><strong>Current Check-out:</strong> {{ selectedReservation ? formatDate(selectedReservation.checkOut) : '' }}</p>
        </div>
        
        <div class="form-group">
          <label for="newCheckoutDate">New Checkout Date:</label>
          <input 
            type="date" 
            id="newCheckoutDate"
            [(ngModel)]="newCheckoutDate" 
            class="form-control"
            [min]="getMinCheckoutDate()"
            [max]="getMaxCheckoutDate()"
            placeholder="YYYY-MM-DD"
          >
        </div>
        
        <!-- Fallback manual input if calendar doesn't work -->
        <div class="form-group" *ngIf="!newCheckoutDate">
          <label for="manualCheckoutDate">Or enter manually (YYYY-MM-DD):</label>
          <input 
            type="text" 
            id="manualCheckoutDate"
            [(ngModel)]="manualCheckoutDate" 
            class="form-control"
            placeholder="2024-01-15"
            pattern="\d{4}-\d{2}-\d{2}"
          >
        </div>

        <div class="new-dates" *ngIf="selectedReservation && (newCheckoutDate || manualCheckoutDate)">
          <p><strong>New Check-out Date:</strong> 
            {{ formatDate(newCheckoutDate || manualCheckoutDate) }}
          </p>
          <p><strong>Additional Days:</strong> 
            {{ getAdditionalDays() }} days
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelExtend()">Cancel</button>
        <button class="btn-confirm" (click)="extendStay()">Extend Stay</button>
      </div>
    </div>
  </div>

  <!-- Checkout Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showCheckoutModal" (click)="cancelCheckout()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirm Checkout</h2>
        <button class="close-btn" (click)="cancelCheckout()">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="warning-message">
          <i class="fa fa-exclamation-triangle"></i>
          <h3>Are you sure you want to check out this guest?</h3>
        </div>

        <div class="guest-info">
          <p><strong>Guest:</strong> {{ selectedReservation ? getGuestName(selectedReservation) : '' }}</p>
          <p><strong>Room Type:</strong> {{ selectedReservation?.roomType }}</p>
          <p><strong>Check-out Date:</strong> {{ selectedReservation ? formatDate(selectedReservation.checkOut) : '' }}</p>
          <p><strong>Total Amount:</strong> {{ selectedReservation ? formatCurrency(calculateTotalAmount(selectedReservation)) : '' }}</p>
        </div>

        <div class="receipt-section">
          <app-receipt
            [selectedReservation]="selectedReservation"
            [paymentAmount]="paymentAmount"
            [billNo]="'BILL-' + selectedReservation?.id"
            (totalCalculated)="onTotalCalculated($event)">
          </app-receipt>
        </div>

        <div class="pos-section">
          <h3>Payment Details</h3>

          <div class="form-group">
            <label>Payment Mode:</label>
            <select [(ngModel)]="paymentMode" class="form-control">
              <option value="Cash">Cash</option>
              <option value="GCash">GCash</option>
              <option value="Card">Card</option>
            </select>
          </div>

          <div class="form-group">
            <label>Amount Received:</label>
            <input type="number" [(ngModel)]="paymentAmount" placeholder="Enter amount" class="form-control">
          </div>

          <p *ngIf="selectedReservation && paymentAmount >= calculateTotalAmount(selectedReservation)">
            <strong>Change:</strong> {{ formatCurrency(paymentAmount - calculateTotalAmount(selectedReservation)) }}
          </p>

          <p *ngIf="selectedReservation && paymentAmount && paymentAmount < calculateTotalAmount(selectedReservation)" class="error">
            Payment is less than total amount.
          </p>
        </div>

        <div class="checkout-note">
          <p><i class="fa fa-info-circle"></i> This action will:</p>
          <ul>
            <li>Check out the selected booking.</li>
            <li><strong>Please confirm the payments to avoid conclusions</strong></li>
            <li>Mark the room as available</li>
          </ul>
        </div>
      </div>

      <!-- Footer Buttons -->
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelCheckout()">No, Cancel</button>
        <button 
          class="btn-confirm" 
          (click)="confirmCheckout()" 
          [disabled]="!canCheckout()">
          Yes, Check Out
        </button>
      </div>
    </div>
  </div>

</div>
