<!-- Policy Modal -->
<app-consent-policy-modal
  [isOpen]="showPolicyModal"
  (closed)="closePolicyModal()">
</app-consent-policy-modal>

<!-- Terms and Conditions Modal -->
<app-terms-conditions-modal
  [isOpen]="showTermsModal"
  (closed)="closeTermsModal()">
</app-terms-conditions-modal>

<!-- Enhanced Guest Details Form with Image -->
<div class="form-container">
  <!-- Left Image Section -->
  <div class="left-side">
    <div class="overlay"></div>
    <img src="assets/images/about-img-2.jpg" alt="Guest" />
  </div>
  
  <!-- Right Form Section -->
  <div class="right-side">
    <div class="form-box">
      <div class="form-header">
        <h2>Guest Details</h2>
        <p class="selected-room">
          Selected Room: <strong>{{ selectedRoomType?.type }}</strong>
        </p>
      </div>

      <form [formGroup]="customerForm" (ngSubmit)="submitFormWithLoading()" class="guest-form">
        
        <!-- First Name -->
        <div class="form-group">
          <input type="text" placeholder="First Name" formControlName="firstName"
            (focus)="onFieldFocus('firstName')" (blur)="onFieldBlur('firstName')" (input)="onFieldChange('firstName')"
            (input)="capitalizeFirstLetter('firstName')"
            [class.error]="hasError('firstName')" [class.valid]="isValid('firstName')" />
          <div class="error-message" *ngIf="hasError('firstName')">{{ getErrorMessage('firstName') }}</div>
        </div>

        <!-- Last Name -->
        <div class="form-group">
          <input type="text" placeholder="Last Name" formControlName="lastName"
            (focus)="onFieldFocus('lastName')" (blur)="onFieldBlur('lastName')" (input)="onFieldChange('lastName')"
            (input)="capitalizeFirstLetter('lastName')"
            [class.error]="hasError('lastName')" [class.valid]="isValid('lastName')" />
          <div class="error-message" *ngIf="hasError('lastName')">{{ getErrorMessage('lastName') }}</div>
        </div>

        <!-- Email -->
        <div class="form-group">
          <input type="email" placeholder="Email (Gmail only)" formControlName="email"
            (focus)="onFieldFocus('email')" (blur)="onFieldBlur('email')" (input)="onFieldChange('email')"
            [class.error]="hasError('email')" [class.valid]="isValid('email')" />
          <div class="error-message" *ngIf="hasError('email')">{{ getErrorMessage('email') }}</div>
          <div class="loading-message" *ngIf="customerForm.get('email')?.pending">
            <div class="spinner"></div>
            <span>Checking email availability...</span>
          </div>
        </div>

        <!-- Phone Number -->
        <div class="form-group">
          <input type="tel" placeholder="Contact Number (+63XXXXXXXXXX)" formControlName="phone"
            (focus)="onFieldFocus('phone')" (blur)="onFieldBlur('phone')" (input)="formatPhoneNumber($event)"
            maxlength="13"
            [class.error]="hasError('phone')" [class.valid]="isValid('phone')" />
          
          <div class="error-message" *ngIf="hasError('phone')">{{ getErrorMessage('phone') }}</div>

          <!-- Loading indicator -->
          <div class="loading-message" *ngIf="phoneChecking">
            <div class="spinner"></div>
            <span>Validating phone number...</span>
          </div>

          <!-- Validation result -->
          <div class="success-message" *ngIf="phoneValid === true">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Phone number is valid</span>
          </div>
          <div class="error-message" *ngIf="phoneValid === false">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Invalid phone number</span>
          </div>
          
          <!-- Help text -->
          <div class="help-text" *ngIf="!phoneChecking && phoneValid === null">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 16V12M12 8H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Format: +63XXXXXXXXXX (10 digits after +63)</span>
          </div>
        </div>

        <!-- Address -->
        <div class="form-group">
          <input type="text" placeholder="Address" formControlName="address"
            (focus)="onFieldFocus('address')" (blur)="onFieldBlur('address')" (input)="onFieldChange('address')"
            (input)="capitalizeFirstLetter('address')"
            [class.error]="hasError('address')" [class.valid]="isValid('address')" />
          <div class="error-message" *ngIf="hasError('address')">{{ getErrorMessage('address') }}</div>
        </div>

        <!-- City -->
        <div class="form-group">
          <input type="text" placeholder="City" formControlName="city"
            (focus)="onFieldFocus('city')" (blur)="onFieldBlur('city')" (input)="onFieldChange('city')"
            (input)="capitalizeFirstLetter('city')"
            [class.error]="hasError('city')" [class.valid]="isValid('city')" />
          <div class="error-message" *ngIf="hasError('city')">{{ getErrorMessage('city') }}</div>
        </div>

        <!-- Postal Code -->
        <div class="form-group">
          <input type="text" placeholder="Postal Code (4 digits)" formControlName="postalCode"
            (focus)="onFieldFocus('postalCode')" (blur)="onFieldBlur('postalCode')" (input)="formatPostalCode($event)"
            maxlength="4"
            [class.error]="hasError('postalCode')" [class.valid]="isValid('postalCode')" />
          <div class="error-message" *ngIf="hasError('postalCode')">{{ getErrorMessage('postalCode') }}</div>
        </div>

        <!-- Special Request -->
        <div class="form-group">
          <textarea placeholder="Special Request (Optional)" formControlName="specialRequests"
            (focus)="onFieldFocus('specialRequests')" (blur)="onFieldBlur('specialRequests')" (input)="onFieldChange('specialRequests')"></textarea>
        </div>

        <!-- Enhanced Consent Checkbox -->
        <div class="consent-section">
          <label class="consent-checkbox">
            <input type="checkbox" formControlName="consentAccepted" (change)="onConsentChange()" />
            <span class="checkmark"></span>
            <span class="consent-text">
              I have read and agree to the 
              <strong class="policy-link" (click)="openTermsModal()">Terms and Conditions</strong>
              and 
              <strong class="policy-link" (click)="openPolicyModal()">Data Collection Policy</strong>
              and consent to the processing of my personal information.
            </span>
          </label>
        </div>

        <!-- Enhanced Action Buttons -->
        <div class="form-actions">
          <button type="button" (click)="back.emit()" class="btn btn-secondary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Back</span>
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!isFormValid() || isFormProcessing()">
            <div class="btn-content" *ngIf="isFormProcessing()">
              <div class="spinner"></div>
              <span>Processing...</span>
            </div>
            <div class="btn-content" *ngIf="!isFormProcessing()">
              <span>Submit Reservation</span>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5 12H19M12 5L19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </button>
        </div>

      </form>
    </div>
  </div>
</div>